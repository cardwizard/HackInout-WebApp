<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/components/icon.min.css" />
<link href="common.css" rel="stylesheet">

<div class="ui sidebar inverted vertical menu">
	<div class="item">
		<a class="ui logo icon image" href="/" style="margin-right: 10px;">
		    <img src="https://ui-avatars.com/api/?name=User&size=32&length=1&background=0D8ABC&color=fff&rounded=true">
		</a>
		<a href="/">
			<b>Welcome User</b>
		</a>
	</div>
	<div class="item">
		<div class="header">
			Menu
		</div>
		<div class="menu">
			<a class="item" href="track.html">Track bus location</a>
			<a class="item" href="share.html">Share bus location</a>
			<a class="item" href="#">Credits</a>
			<a class="item" href="#">Logout</a>
		</div>
	</div>
</div>
<div class="pusher">
	<div id="scan_qr_code">
		<button class="ui button basic top-left" id="menu">
			<i class="sidebar icon"></i> Menu
		</button>
		<video id="preview" width="100%" height="100%"></video>
		<div class="cameras">
		</div>
	</div>
	<div id="share_info">
		<div class="ui form" style="padding: 20px 10%;">
			<h2 class="ui center aligned icon header">
				<i class="circular marker icon"></i>
				Share location &amp; buy tickets
			</h2>
			<h2 class="ui sub header">
	  			Bus number
			</h2>
			<span id="bus_number"></span>
			<h2 class="ui sub header">
	  			Route number
			</h2>
			<span id="route_number"></span>

			<h2 class="ui sub header">
			</h2>
			<div class="inline field">
				<div class="ui checkbox" id="terms">
					<input type="checkbox" tabindex="0" class="hidden" id="tc">
					<label>I have read the <a href="#">terms and conditions</a> and agree to share the real-time location of bus.</label>
				</div>
			</div>

			<h2 class="ui sub header">
			</h2>
			<button class="positive ui button" id="start">Start sharing</button>
			<button class="basic ui button" id="rescan">Cancel</button>

			<h2 class="ui sub header">
			</h2>
			<div class="ui warning message">
				You must accept the <a href="#">terms and conditions</a> before you can start sharing bus location for other users.
			</div>
		</div>
	</div>
	<div id="stop_sharing" style="text-align: center; padding-top: 25%;">
		<button class="negative ui button" id="stop">Stop sharing</button>
	</div>
</div>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript" src="instascan.min.js"></script>

<script type="text/javascript">
	
	var supported_cameras = [];
	var bus_info;

	var base_url = "https://0573ef3d.ngrok.io"
	var all_bus_stops = [];

	var info_pusher;

	function share_bus_location(latitude, longitude) {
		axios.get(base_url+'/v1/share_bus_location',  {
	    		params: {
	    			user_id: "Kiran",
	      			bus_number: bus_info["bus_number"],
	      			route_number: bus_info["route_number"],
	      			latitude: latitude,
	      			longitude: longitude,
	    		}
	  		})
			.then(function (response) {
				console.log(response);
			})
			.catch(function (error) {
				console.log(error);
			});
	}

	function stop_sharing(latitude, longitude) {
		axios.get(base_url+'/v1/stop_sharing',  {
	    		params: {
	    			user_id: "Kiran",
	      			bus_number: bus_info["bus_number"],
	      			route_number: bus_info["route_number"],
	      			latitude: latitude,
	      			longitude: longitude,
	    		}
	  		})
			.then(function (response) {
				console.log(response);
				read_qr_code();
			})
			.catch(function (error) {
				console.log(error);
			});
	}

	$('#scan_qr_code').show();
	$('#share_info').hide();
	$('#stop_sharing').hide();
	$('.ui.warning.message').hide();

	$('#terms').checkbox();

	let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });

	scanner.addListener('scan', function (content) {
		try {
			bus_info = JSON.parse(content);	

			if ("route_number" in bus_info && "bus_number" in bus_info)
			{
				$('#share_info #bus_number').html(bus_info['bus_number']);
				$('#share_info #route_number').html(bus_info['route_number']);

				scanner.stop().then(function() {
					$('#scan_qr_code').hide();
					$('#share_info').show();
					$('#stop_sharing').hide();
				});	
			}
		}
		catch (e) {
			console.log(e);
		}
		
	});

	Instascan.Camera.getCameras().then(function (cameras) {
		// Persist all supported camera related information
		supported_cameras = cameras;

		// Create icons for each camera
		for (var i in cameras) {
			$('.cameras').append('<div class="ui icon button " data-camera="'+ i +'" data-tooltip="'+cameras[i]["name"]+'" data-inverted=""><i class="camera retro icon"></i></div>')
		}

		// Activate first camera by default
		if (cameras.length > 0) {
			scanner.start(cameras[0]);
			$('.cameras .camera.icon').eq(0).addClass('selected');
		} else {
			console.error('No cameras found.');
		}
	}).catch(function (e) {
		console.error(e);
	});

	function read_qr_code() {

		bus_info = null;
		
		$('#scan_qr_code').show();
		$('#share_info').hide();
		$('#stop_sharing').hide();

		$('.ui.warning.message').hide();
		$('#terms').checkbox('set unchecked');

		scanner.start(supported_cameras[0]);
	}

	$('#start').click(function(event) {
		if($('#tc').is(':checked'))
		{
			
			$('#scan_qr_code').hide();
			$('#share_info').hide();
			$('#stop_sharing').show();

			$('.ui.warning.message').hide();

			// Todo: Start pushing co-ordinates every 5 seconds.
			navigator.geolocation.getCurrentPosition(function(position){
				share_bus_location(position.coords.latitude, position.coords.longitude);
			});

			info_pusher = setInterval(function(){
				navigator.geolocation.getCurrentPosition(function(position){
					share_bus_location(position.coords.latitude, position.coords.longitude);
				});			
			}, 3000);
			

		} else {
			$('.ui.warning.message').show();	
		}
	});

	$('#rescan').click(function(event) {
		read_qr_code();
	});

	$('#stop').click(function(event) {
		clearTimeout(info_pusher);
		navigator.geolocation.getCurrentPosition(function(position){
			stop_sharing(position.coords.latitude, position.coords.longitude);
		});
	});

	$('#menu').click(function(event) {
		/* Act on the event */
		$('.ui.sidebar').sidebar('toggle');
	});

</script>

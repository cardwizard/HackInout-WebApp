<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/components/icon.min.css" />
<link href="common.css" rel="stylesheet">

<div class="ui sidebar inverted vertical menu">
	<div class="item">
		<a class="ui logo icon image" href="/" style="margin-right: 10px;">
		    <img src="https://ui-avatars.com/api/?name=User&size=32&length=1&background=0D8ABC&color=fff&rounded=true">
		</a>
		<a href="/">
			<b>Welcome User</b>
		</a>
	</div>
	<div class="item">
		<div class="header">
			Menu
		</div>
		<div class="menu">
			<a class="item" href="track.html">Track bus location</a>
			<a class="item" href="share.html">Share bus location</a>
			<a class="item" href="#">Ride history</a>
			<a class="item" href="#">Profile</a>
			<a class="item" href="#">Credits</a>
			<a class="item" href="#">Logout</a>
		</div>
	</div>
</div>
<div class="pusher">
	<div id="scan_qr_code">
		<div class="ui fixed borderless menu">
			<div class="ui container">
	      		<a href="#" class="header item">
	        		<i class="sidebar icon" id="menu"></i>
	      		</a>
			</div>
		</div>
		<h2 class="ui center aligned icon header" style="margin: 96px 48px 48px 48px;">
			<i class="circular qrcode icon"></i>
			Scan QR code
		</h2>
		<video id="preview" width="100%"></video>
		<div class="cameras">
		</div>
	</div>
	<div id="share_info">
		<div class="ui form" style="padding: 48px 10%;">
			<h2 class="ui center aligned icon header" style="margin-bottom: 32px;">
				<i class="circular marker icon"></i>
				Share location &amp; buy tickets
			</h2>
			<div class="ui grid">
				<div class="eight wide column">
					<h2 class="ui sub header">
			  			Bus number
					</h2>
					<span id="bus_number"></span>
				</div>
				<div class="eight wide column">
					<h2 class="ui sub header">
			  			Route number
					</h2>
					<span id="route_number"></span>
				</div>
			</div>

			<div class="field" style="margin-top: 15px;">
				<div class="sixteen wide field">
					<div class="ui search" id="from-wrapper">
						<div class="ui icon input">
							<input class="prompt" type="text" placeholder="Enter pickup location" id="from">
							<i class="search icon"></i>
						</div>
						<div class="results"></div>
					</div>
				</div>
			</div>
			<div class="field">
				<div class="sixteen wide field">
					<div class="ui search" id="to-wrapper">
						<div class="ui icon input">
							<input class="prompt" type="text" placeholder="Where to?" id="to">
							<i class="search icon"></i>
						</div>
						<div class="results"></div>
					</div>
				</div>
			</div>

			<div class="field">
				<div class="sixteen wide field">
					<div class="ui input">
	  					<input type="number" placeholder="No. of tickets" id="qty">
					</div>
				</div>
			</div>

			<h2 class="ui sub header">
				Total: INR <span id="fare"></span>
			</h2>

			<h2 class="ui sub header">
			</h2>
			<div class="inline field">
				<div class="ui checkbox" id="terms">
					<input type="checkbox" tabindex="0" class="hidden" id="tc">
					<label>I have read the <a href="#">terms and conditions</a> and agree to share the real-time location of bus.</label>
				</div>
			</div>

			<h2 class="ui sub header">
			</h2>
			<a class="positive ui button" href="https://mercury-demo.phonepe.com/pay_demo" target="_blank" onclick="pay(); return false;">Pay</a>
			<button class="positive ui button" id="start">Start sharing</button>
			<button class="basic ui button" id="rescan">Cancel</button>

			<h2 class="ui sub header">
			</h2>
			<div class="ui warning message">
				Fill all the information before you can proceed.
			</div>
		</div>
	</div>
	<div id="stop_sharing" style="text-align: center; padding: 48px 10%;">
		<button class="negative ui button" id="stop">Stop sharing</button>
	</div>
</div>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript" src="instascan.min.js"></script>

<script type="text/javascript">
	
	var supported_cameras = [];
	var bus_info = {};

	var base_url = "http://127.0.0.1:5000"
	var all_bus_stops = [];
	var bus_stops = [];

	var info_pusher;


	function share_bus_location(latitude, longitude) {
		axios.get(base_url+'/v1/share_bus_location',  {
	    		params: {
	    			user_id: "Kiran",
	      			bus_number: bus_info["bus_number"],
	      			route_number: bus_info["route_number"],
	      			latitude: latitude,
	      			longitude: longitude,
	    		}
	  		})
			.then(function (response) {
				console.log(response);
			})
			.catch(function (error) {
				console.log(error);
			});
	}

	function stop_sharing(latitude, longitude) {
		axios.get(base_url+'/v1/stop_sharing',  {
	    		params: {
	    			user_id: "Kiran",
	      			bus_number: bus_info["bus_number"],
	      			route_number: bus_info["route_number"],
	      			latitude: latitude,
	      			longitude: longitude,
	    		}
	  		})
			.then(function (response) {
				console.log(response);
				go_to_home();
			})
			.catch(function (error) {
				console.log(error);
			});
	}

	function get_stops() {
		axios.get(base_url+'/v1/get_stops', {
				params: {
					route_number: bus_info["route_number"],
					bus_number: bus_info["bus_number"]
				}
			})
			.then(function (response) {
				bus_stops = response["data"];
				$('.ui.search').search({source: bus_stops});
			})
			.catch(function (error) {
				console.log(error);
			});
	}

	function pay() {
		if(valid_form())
		{
			$('.ui.warning.message').hide();
			window.open('https://mercury-demo.phonepe.com/pay_demo', '_blank');
		}
		else
			$('.ui.warning.message').show();
	}

	function valid_form() {
		return $('#tc').is(':checked') && $('#qty').val() != '' && $('#from-wrapper').search('get value') != '' && $('#to-wrapper').search('get value') != '';
	}

	let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });

	scanner.addListener('scan', function (content) {
		try {
			bus_info = JSON.parse(content);	

			if ("route_number" in bus_info && "bus_number" in bus_info)
				start_tracking();
		}
		catch (e) {
			console.log(e);
		}
	});

	Instascan.Camera.getCameras().then(function (cameras) {
		// Persist all supported camera related information
		supported_cameras = cameras;

		// Create icons for each camera
		for (var i in cameras) {
			$('.cameras').append('<div class="ui icon button " data-camera="'+ i +'" data-tooltip="'+cameras[i]["name"]+'" data-inverted=""><i class="camera retro icon"></i></div>')
		}

		// Activate first camera by default
		if (cameras.length > 0 && !("route_number" in bus_info && "bus_number" in bus_info)) {
			scanner.start(cameras[0]);
			$('.cameras .camera.icon').eq(0).addClass('selected');
		} else {
			console.error('No cameras found/bus info already available.');
		}
	}).catch(function (e) {
		console.error(e);
	});

	if (window.location.search){
		query_params_str = window.location.search.substr(1);
		query_params_str.replace(/([^=&]+)=([^&]*)/g, function(m, key, value) {
			bus_info[decodeURIComponent(key)] = decodeURIComponent(value);
		}); 

		if ("route_number" in bus_info && "bus_number" in bus_info)
			start_tracking();

	} else {
		$('#scan_qr_code').show();
		$('#share_info').hide();
		$('#stop_sharing').hide();	
	}

	$('.ui.warning.message').hide();
	$('#terms').checkbox();

	function start_tracking() {
		$('#share_info #bus_number').html(bus_info['bus_number']);
		$('#share_info #route_number').html(bus_info['route_number']);
		$('#share_info #from-wrapper').search('set value', bus_info["from"]);
		$('#share_info #to-wrapper').search('set value', bus_info["to"]);

		get_stops();

		scanner.stop().then(function() {
			$('#scan_qr_code').hide();
			$('#share_info').show();
			$('#stop_sharing').hide();
		});
	}

	function go_to_home() {
		window.location.href = "/";
	}

	$('#qty').change(function(event) {
		qty = Number($(this).val());
		if(!isNaN(qty))
			$('#fare').text(parseFloat(qty * 12).toFixed(2));
	});

	$('#start').click(function(event) {
		if(valid_form())
		{
			
			$('#scan_qr_code').hide();
			$('#share_info').hide();
			$('#stop_sharing').show();

			$('.ui.warning.message').hide();

			// Todo: Start pushing co-ordinates every 5 seconds.
			navigator.geolocation.getCurrentPosition(function(position){
				share_bus_location(position.coords.latitude, position.coords.longitude);
			});

			info_pusher = setInterval(function(){
				navigator.geolocation.getCurrentPosition(function(position){
					share_bus_location(position.coords.latitude, position.coords.longitude);
				});			
			}, 3000);
			

		} else {
			$('.ui.warning.message').show();	
		}
	});

	$('#rescan').click(function(event) {
		go_to_home();
	});

	$('#stop').click(function(event) {
		clearTimeout(info_pusher);
		navigator.geolocation.getCurrentPosition(function(position){
			stop_sharing(position.coords.latitude, position.coords.longitude);
		});
	});

	$('#menu').click(function(event) {
		/* Act on the event */
		$('.ui.sidebar').sidebar('toggle');
	});

</script>
